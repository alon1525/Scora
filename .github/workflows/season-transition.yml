name: Season Transition

on:
  schedule:
    # Run every day at 6 AM UTC (8 AM in Israel)
    - cron: '0 6 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  check-and-transition:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install dependencies
      run: |
        cd backend
        npm install
        
    - name: Check if season transition is needed
      id: check-transition
      run: |
        cd backend
        node -e "
        const https = require('https');
        const options = {
          hostname: 'scora-nine.vercel.app',
          port: 443,
          path: '/api/seasons/check-transition',
          method: 'GET'
        };
        
        const req = https.request(options, (res) => {
          let data = '';
          res.on('data', (chunk) => data += chunk);
          res.on('end', () => {
            const result = JSON.parse(data);
            console.log('Transition check result:', result);
            if (result.success && result.needsTransition) {
              console.log('::set-output name=needs_transition::true');
              console.log('::set-output name=is_transition_time::' + result.isTransitionTime);
            } else {
              console.log('::set-output name=needs_transition::false');
              console.log('::set-output name=is_transition_time::' + result.isTransitionTime);
            }
          });
        });
        
        req.on('error', (error) => {
          console.error('Error checking transition:', error);
          console.log('::set-output name=needs_transition::false');
        });
        
        req.end();
        "
        
    - name: Perform season transition
      if: steps.check-transition.outputs.needs_transition == 'true'
      run: |
        cd backend
        node -e "
        const https = require('https');
        const options = {
          hostname: 'scora-nine.vercel.app',
          port: 443,
          path: '/api/seasons/transition',
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-transition-secret': '${{ secrets.CRON_SECRET }}'
          }
        };
        
        const req = https.request(options, (res) => {
          let data = '';
          res.on('data', (chunk) => data += chunk);
          res.on('end', () => {
            const result = JSON.parse(data);
            console.log('Transition result:', result);
            if (result.success) {
              console.log('✅ Season transition completed successfully');
              console.log('New season:', result.newSeason);
            } else {
              console.error('❌ Season transition failed:', result.error);
              process.exit(1);
            }
          });
        });
        
        req.on('error', (error) => {
          console.error('Error during transition:', error);
          process.exit(1);
        });
        
        req.end();
        "
        
    - name: Notify on success
      if: steps.check-transition.outputs.needs_transition == 'true'
      run: |
        echo "✅ Season transition completed successfully on $(date)"
        echo "New season has been activated and user data has been reset"
        
    - name: Notify on no transition needed
      if: steps.check-transition.outputs.needs_transition == 'false'
      run: |
        echo "ℹ️ No season transition needed on $(date)"
        echo "Current date: $(date)"
        echo "Is transition time: ${{ steps.check-transition.outputs.is_transition_time }}"
