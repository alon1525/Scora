name: Season Transition

on:
  schedule:
    # Run every day at 6 AM UTC (8 AM in Israel)
    - cron: '0 6 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  check-and-transition:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install dependencies
      run: |
        cd backend
        npm install
        
    - name: Check if season transition is needed
      id: check-transition
      continue-on-error: true
      run: |
        cd backend
        node -e "
        const https = require('https');
        const fs = require('fs');
        const options = {
          hostname: 'scora-nine.vercel.app',
          port: 443,
          path: '/api/seasons/check-transition',
          method: 'GET'
        };
        
        const req = https.request(options, (res) => {
          let data = '';
          res.on('data', (chunk) => data += chunk);
          res.on('end', () => {
            try {
              const result = JSON.parse(data);
              console.log('Transition check result:', result);
              const needsTransition = result.success && result.needsTransition;
              const isTransitionTime = result.isTransitionTime || false;
              
              // Use new GitHub Actions output format
              const outputFile = process.env.GITHUB_OUTPUT;
              if (outputFile) {
                fs.appendFileSync(outputFile, \`needs_transition=\${needsTransition}\\n\`);
                fs.appendFileSync(outputFile, \`is_transition_time=\${isTransitionTime}\\n\`);
              } else {
                // Fallback for older format (though deprecated)
                console.log(\`::set-output name=needs_transition::\${needsTransition}\`);
                console.log(\`::set-output name=is_transition_time::\${isTransitionTime}\`);
              }
              
              if (needsTransition) {
                console.log('✅ Season transition is needed');
              } else {
                console.log('ℹ️ No season transition needed at this time');
              }
            } catch (parseError) {
              console.error('Error parsing response:', parseError);
              console.log('Response was:', data);
              // Set outputs to false on error
              const outputFile = process.env.GITHUB_OUTPUT;
              if (outputFile) {
                fs.appendFileSync(outputFile, 'needs_transition=false\n');
                fs.appendFileSync(outputFile, 'is_transition_time=false\n');
              }
            }
          });
        });
        
        req.on('error', (error) => {
          console.error('Error checking transition:', error);
          console.log('ℹ️ Assuming no transition needed due to error');
          // Set outputs to false on error
          const outputFile = process.env.GITHUB_OUTPUT;
          if (outputFile) {
            fs.appendFileSync(outputFile, 'needs_transition=false\n');
            fs.appendFileSync(outputFile, 'is_transition_time=false\n');
          }
        });
        
        req.setTimeout(30000, () => {
          console.error('Request timeout');
          req.destroy();
          const outputFile = process.env.GITHUB_OUTPUT;
          if (outputFile) {
            fs.appendFileSync(outputFile, 'needs_transition=false\n');
            fs.appendFileSync(outputFile, 'is_transition_time=false\n');
          }
        });
        
        req.end();
        "
        
    - name: Perform season transition
      if: steps.check-transition.outputs.needs_transition == 'true'
      run: |
        cd backend
        node -e "
        const https = require('https');
        const options = {
          hostname: 'scora-nine.vercel.app',
          port: 443,
          path: '/api/seasons/transition',
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-transition-secret': '${{ secrets.CRON_SECRET }}'
          }
        };
        
        const req = https.request(options, (res) => {
          let data = '';
          res.on('data', (chunk) => data += chunk);
          res.on('end', () => {
            const result = JSON.parse(data);
            console.log('Transition result:', result);
            if (result.success) {
              console.log('✅ Season transition completed successfully');
              console.log('New season:', result.newSeason);
            } else {
              console.error('❌ Season transition failed:', result.error);
              process.exit(1);
            }
          });
        });
        
        req.on('error', (error) => {
          console.error('Error during transition:', error);
          process.exit(1);
        });
        
        req.end();
        "
        
    - name: Notify on success
      if: steps.check-transition.outputs.needs_transition == 'true'
      run: |
        echo "✅ Season transition completed successfully on $(date)"
        echo "New season has been activated and user data has been reset"
        
    - name: Notify on no transition needed
      if: always() && steps.check-transition.outputs.needs_transition != 'true'
      run: |
        echo "ℹ️ No season transition needed on $(date)"
        echo "Current date: $(date)"
        echo "Is transition time: ${{ steps.check-transition.outputs.is_transition_time }}"
        echo "This is expected behavior when it's not yet time for season transition."
